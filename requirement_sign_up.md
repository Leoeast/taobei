# 注册功能需求说明书（requirement_sign_up.md）

## 1. 背景与目标
为新用户提供基于手机号的快速注册流程：用户输入手机号，通过图形验证码（captcha）验证后请求短信验证码，阅读并同意用户协定，完成注册并登录。目标是兼顾安全、易用、合规与可观测性。

## 2. 范围
- 注册入口页面（或弹窗）
- 后端验证与短信发送接口
- 协议展示与勾选逻辑
- 数据落库与风控

## 3. 用户与场景
- 新用户首次进入，想要创建账户并登录。
- 可能的弱网、验证码输错、短信延迟、重复发送等情况。

## 4. 术语
- 手机号：大陆手机号（默认），后续可扩展国际号码。
- captcha：图形验证码或滑块验证码，用于区分人机。
- 短信验证码：一次性 6 位数字，5 分钟有效。
- 用户协定：用户协议与隐私政策。

## 5. 功能需求
1) 手机号输入与校验
- 支持中国大陆手机号格式校验：11 位，以 1 开头；可扩展国际区号。
- 前端实时校验与后端二次校验。

2) 图形验证码验证
- 展示 captcha（图形/滑块），通过后方可发送短信验证码。
- 验证失败给出明确提示，支持刷新。

3) 短信验证码发送
- 通过后端接口发送 6 位验证码，有效期 5 分钟。
- 发送频控：单号码 60 秒内不可重复请求；每日最多 10 次。
- 展示倒计时与重发按钮状态。

4) 用户协定阅读与同意
- 提供《用户协议》《隐私政策》入口（弹窗或新页）。
- 必须勾选同意方可提交注册。

5) 注册提交与登录
- 提交手机号、短信验证码、协议勾选状态。
- 验证成功后创建用户并登录，返回会话凭证（如 JWT 或 Session）。

## 6. 业务流程（主流程）
- 用户输入手机号 → 前端基本校验 → 展示 captcha → 验证通过 → 请求发送短信验证码 → 用户输入短信验证码 → 勾选同意用户协定 → 提交注册 → 成功登录进入首页。

异常流程要点：
- captcha 未通过：禁止发短信，提示并允许重试。
- 短信频率超限：提示稍后重试，倒计时显示。
- 验证码错误/过期：提示错误或过期并允许重发。
- 未勾选协议：提示必须同意后提交。

## 7. UI/交互要求
- 输入框：手机号、短信验证码；验证码输入框支持粘贴。
- captcha 区域：可刷新/重试，失败有错误态。
- 按钮：
  - 发送验证码：通过 captcha 后可点击；倒计时禁用。
  - 提交注册：手机号与验证码有效且勾选协议后可点击。
- 文案与提示：清晰、简短，错误提示就近展示。
- 无障碍：为输入和按钮提供可访问标签；错误信息可被屏幕阅读器读出。

## 8. 校验规则
- 手机号：大陆手机号正则 ^1\d{10}$；后端再校验并做号段白/黑名单扩展。
- captcha：一次验证有效期 2 分钟，失败 3 次触发更强验证（如滑块）。
- 短信验证码：6 位数字；验证失败累计 5 次锁定 30 分钟。
- 协议：必须勾选，记录同意版本与时间。

## 9. API 设计（建议）
- POST /api/auth/captcha/verify
  - 入参：{ sessionId, captchaToken }
  - 出参：{ success: true }
- POST /api/auth/sms/send
  - 入参：{ phone, purpose: "register", captchaPassed: true }
  - 出参：{ success: true, cooldownSec: 60 }
- POST /api/auth/register
  - 入参：{ phone, code, agree: true, agreementVersion }
  - 出参：{ success: true, user: { id, phone }, token }
- GET /api/legal/user-agreement
  - 出参：{ version, title, contentHtml }

错误码示例：
- 400_INVALID_PHONE, 400_INVALID_CAPTCHA, 429_TOO_MANY_REQUESTS,
- 400_CODE_INVALID, 400_CODE_EXPIRED, 400_AGREEMENT_REQUIRED。

## 10. 数据模型（与现有表对齐）
- users：id, phone(唯一), created_at, updated_at, agreement_version(可选), agreement_accepted_at(可选)
- verification_codes：id, phone, code(建议哈希存储), purpose(register), expires_at, used, created_at

## 11. 安全与风控
- 速率限制：按 IP 与手机号限流（如 15 分钟 100 次已在后端）。
- 人机识别：captcha 必须通过后才可发短信。
- 验证码存储：使用哈希（如 HMAC-SHA256）存储，避免明文泄露。
- 重放保护：验证码一次性使用，验证成功后置 used=true。
- 失败锁定：同号码验证失败达 5 次，临时锁定 30 分钟。

## 12. 合规与隐私
- 明示收集手机号用途；提供隐私政策入口。
- 日志脱敏（部分掩码手机号）；遵守短信平台合规要求。

## 13. 性能与可用性
- 短信接口调用超时控制（如 3s）；失败重试最多 2 次。
- 前端展示发送状态与重试引导。

## 14. 埋点与监控
- 埋点：页面曝光、发送点击、成功/失败、验证通过/失败、协议查看/勾选。
- 监控：短信通道成功率、耗时、错误码分布；注册转化漏斗。

## 15. 可测试性与验收标准
- 验收标准：
  - 合法手机号 + captcha 通过后可发送短信；60 秒内不可重复。
  - 正确验证码 + 勾选协议即可注册成功并获得登录态。
  - 错误验证码、过期、超限场景提示明确。
  - 数据库写入 users 与 verification_codes 状态正确（used 标记）。
- 关键测试用例：
  - 手机号格式正确/错误；captcha 通过/失败；短信发送成功/频控限制。
  - 验证码正确/错误/过期/已使用；协议未勾选/已勾选。
  - 弱网/短信通道失败重试；多次失败锁定与解锁。

## 16. 里程碑
- M1：接口与数据结构就绪（后端）
- M2：前端页面与交互实现，联调通过
- M3：埋点、监控与风险策略上线
- M4：联调测试、验收与发布

## 17. 备注
- 国际化与多国家号码支持可作为后续增强。
- captcha 类型（图形/滑块）由安全策略决定，可抽象统一验证接口。
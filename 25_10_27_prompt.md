# 2025-10-27 会话提示词导出

以下为本次会话中用户提出的需求与助手在代码层面的修改、提示词/实施要点汇总，便于归档与后续协作。

## 页面与样式调整
- 找回登录密码（ForgotPasswordForm）：
  - 图形验证码图片改为项目公共资源 `/captcha.png`，由 Vite 静态目录 `frontend/public` 提供；加载失败时回退为文字题面。
  - 对齐登录页的图片容器样式，新增 `.captcha-img` 保证图片在固定容器内自适应不变形（`object-fit: contain`），容器采用与登录页一致的尺寸与边框（`min-width: 110px; height: 44px; padding: 0 12px; border: 1px solid #d9d9d9;`）。
  - 输入框 placeholder 保留为「请输入图形验证码」，题面通过图片与 aria 文案呈现（提升可访问性）。
  - 补充错误反馈文案：手机号不合法、图形验证码错误（非 91）、短信验证码未填、两次密码不一致或长度不足等。

## 伪功能：验证码与图形验证码
- 常量设定：
  - 默认短信验证码 DEV_SMS_CODE 为 `123456`。
  - 图形验证码题面为 `13 + 78 = ?`，正确答案 DEV_CAPTCHA_ANSWER 为 `91`。
- 获取验证码的前置条件（找回登录密码）：
  - 仅当手机号合法且输入的图形验证码为 `91` 时，允许点击「获取验证码」。
- 短信验证码前端校验（登录与忘记密码）：
  - 在请求完成并收到后端返回的随机验证码（`debugCode`）时，用户输入必须与 `debugCode` 一致；
  - 若后端未返回 `debugCode`，则用户输入必须为默认验证码 `123456`；
  - 不匹配时在前端直接给出错误提示并阻断后续提交。

## 登录方式与二维码
- 登录页左侧二维码图片继续使用公共资源 `/qrcode.png`（`frontend/public/qrcode.png`），保持绝对路径引用，确保 Vite 正常加载与显示。
- 登录方式切换（短信/密码）逻辑保持不变，本次主要聚焦短信验证码的前端校验与忘记密码流程的图形验证码校验。

## 数据库与后端接口
- 技术栈与启动：
  - 后端使用 Node.js + Express，安全与通用中间件：`helmet`、`cors`、`express-rate-limit`（15 分钟内每 IP 100 次）。
  - 数据库使用 `better-sqlite3`，开发/生产环境落库至 `backend/data/app.db`，测试环境使用内存库（`:memory:`）。
  - 服务器启动时调用 `initializeDatabase()` 自动建表与简易迁移；默认端口 `3000`，支持 `PORT` 环境变量（示例：`PORT=3001`）。
  - 伪功能开关：通过 `PSEUDO_SMS=true` 控制是否跳过后端验证码校验，并在请求验证码时返回 `debugCode` 供前端工作台展示。
- 数据表结构：
  - `users` 表（字段：`id`、`username`、`phone` 唯一、`password_hash`、`created_at`、`updated_at`）。
    - 兼容迁移：若旧表缺少 `username` 或 `password_hash`，启动时补充列，其中 `password_hash` 旧用户默认占位 `legacy-no-password`，首次设置/重置密码时更新。
  - `verification_codes` 表（字段：`id`、`phone`、`code`、`purpose`、`expires_at`、`used`、`created_at`）。
    - 索引优化：`idx_verif_codes_phone_purpose_created` 与 `idx_verif_codes_lookup` 提升限频与校验查询性能。
- 仓储层（repository）：
  - 用户：`getUserByPhone`、`getUserByUsername`、`insertUser`、`updateUserPassword`。
  - 验证码：`getLatestCodeForPurpose`（检索最近一次）、`getValidCode`（校验未过期且未使用）、`insertCode`、`markCodeUsed`、`deleteCodesByPhone`（清除旧验证码）。
- 接口与业务规则（`/api/auth/*`）：
  - `POST /api/auth/request-code`：校验手机号与用途（`login|register|reset`），同一手机号+用途 60 秒内限频；清理旧验证码，仅保留最新一条；生成 6 位随机验证码与 60 秒有效期；在 `PSEUDO_SMS=true` 时返回 `debugCode` 字段。
  - `POST /api/auth/login`：
    - 短信登录：校验手机号存在；在真实模式下校验验证码有效并标记为已使用；在伪功能模式下跳过验证码校验；最终返回 `userId` 与简易 `token`。
    - 密码登录：支持账号或手机号；使用 `bcryptjs` 校验密码哈希；未设置密码的旧账号返回 `401 Password not set.`。
  - `POST /api/auth/register`：
    - 真实模式下必须校验验证码有效（用途 `register`），并标记已使用；
    - 已存在用户：允许为 `legacy-no-password` 账号设置新密码并直接登录；
    - 新用户：校验 `username` 与 `password`（≥6 位），落库并返回 `userId` 与 `token`；当 `agreeAgreement === false` 返回 `412`。
  - `POST /api/auth/reset-password`：
    - 真实模式下校验验证码有效（用途 `reset`）并标记已使用；
    - 使用 `bcryptjs` 更新新密码哈希；返回 `200 Password updated.`。
  - 统一错误码：`400` 输入格式错误、`401` 验证/密码错误、`404` 账号/手机号不存在、`412` 协议未同意、`429` 频率限制。
  - 健康检查：`GET /health` 返回运行状态。

### 附录 A：数据库 DDL（完整 SQL）

```sql
-- users 表
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT NOT NULL,
  phone TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 兼容迁移：启动时检查缺失列并补充
PRAGMA table_info('users');
-- 若缺少 username：
ALTER TABLE users ADD COLUMN username TEXT NOT NULL DEFAULT '';
UPDATE users SET username = COALESCE(username, phone);
-- 若缺少 password_hash：
ALTER TABLE users ADD COLUMN password_hash TEXT NOT NULL DEFAULT 'legacy-no-password';

-- verification_codes 表
CREATE TABLE IF NOT EXISTS verification_codes (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  phone TEXT NOT NULL,
  code TEXT NOT NULL,
  purpose TEXT NOT NULL,
  expires_at DATETIME NOT NULL,
  used BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引优化
CREATE INDEX IF NOT EXISTS idx_verif_codes_phone_purpose_created ON verification_codes (phone, purpose, created_at);
CREATE INDEX IF NOT EXISTS idx_verif_codes_lookup ON verification_codes (phone, code, purpose, expires_at, used);
```

### 附录 B：ER 图（文本说明）
- users(1) —— verification_codes(N) 之间通过 `phone` 字段形成逻辑关联（当前未使用外键约束）。
- verification_codes 记录同一手机号在不同场景（purpose = login/register/reset）的验证码，包含过期时间与使用标记。
- 生产环境建议将 `verification_codes.phone` 改为引用 `users.id` 的外键以增强一致性与约束力。

### 附录 C：迁移与回滚策略
- 当前项目采用「运行时自迁移」：应用启动时检查 users 表结构（PRAGMA），对缺失列执行 ALTER TABLE 添加，并进行数据回填（username 默认回填为 phone，旧密码哈希占位为 legacy-no-password）。
- SQLite 不支持直接删除列，如需回滚或结构性调整，建议：
  1) 创建新表 new_users（目标结构）；
  2) 将旧表数据迁移至新表（按字段映射处理占位值与默认值）；
  3) 删除旧表并重命名新表为 users；
  4) 重建相关索引。
- 验证码清理策略：在 `request-code` 中对同手机号的历史验证码进行清理（repo.deleteCodesByPhone），仅保留最新一条（满足工作台与测试要求）。

### 附录 D：后端启动与环境变量示例（Windows PowerShell）
- 开发模式 + 伪功能：
  - `cd backend`
  - `$env:PSEUDO_SMS='true'; node src/app.js`
- 开发模式 + 真实验证码校验：
  - `cd backend`
  - `$env:PSEUDO_SMS='false'; node src/app.js`
- 指定端口示例：
  - `$env:PSEUDO_SMS='true'; $env:PORT='3001'; node src/app.js`
- 测试模式（内存库）：
  - `$env:NODE_ENV='test'; node src/app.js`

### 附录 E：接口规范（入参/出参示例）
- POST `/api/auth/request-code`
  - 入参：`{ phoneNumber: string, purpose: 'login' | 'register' | 'reset' }`
  - 出参（真实/伪功能通用）：`{ message: 'Code generated.' }`
  - 伪功能开启（PSEUDO_SMS=true）额外字段：`{ debugCode: '123456' }`（实际为当次生成的随机 6 位码）
  - 错误示例：`400 Invalid input or format.`、`400 Invalid phone format.`、`400 Invalid purpose.`、`429 Too many requests...`
- POST `/api/auth/login`
  - 短信登录入参：`{ phoneNumber: string, verificationCode: string }`
  - 密码登录入参：`{ accountOrPhone: string, password: string }`
  - 成功出参：`{ userId: string, token: string }`
  - 错误示例：`404 Phone not registered.`、`404 Account not found.`、`401 Verification code invalid.`、`401 Incorrect password.`、`401 Password not set.`、`400 Invalid input or format.`
- POST `/api/auth/register`
  - 入参：`{ username: string, phoneNumber: string, password: string, verificationCode?: string, agreeAgreement?: boolean }`
  - 成功出参（已存在用户）：`{ userId: string, token: string, existingUser: true }`
  - 成功出参（新用户）：`201 { userId: string, token: string }`
  - 错误示例：`412 Agreement not accepted.`、`401 Verification code invalid.`、`400 Invalid input or format.`
- POST `/api/auth/reset-password`
  - 入参：`{ phoneNumber: string, verificationCode?: string, newPassword: string }`（真实模式下 verificationCode 必填）
  - 成功出参：`{ message: 'Password updated.' }`
  - 错误示例：`404 Phone not registered.`、`401 Verification code invalid.`、`400 Invalid input or format.`
- GET `/health`
  - 出参：`{ status: 'ok', timestamp: string }`

### 附录 F：错误码字典（按场景）
- 400 Invalid input or format.
  - 入参缺失或类型/格式不合法（手机号、密码长度 < 6、purpose 不在枚举、JSON 格式不符等）。
- 401 Verification code invalid. / Incorrect password. / Password not set.
  - 验证码过期/已使用/不匹配；密码错误；旧账号未设置密码。
- 404 Phone not registered. / Account not found.
  - 手机号不存在或根据账号/手机号未找到用户。
- 412 Agreement not accepted.
  - 注册时用户未同意用户协议。
- 429 Too many requests.
  - 同手机号+用途 60 秒内限频触发。
- 500 Internal server error.
  - 非预期异常统一错误。

### 附录 G：安全策略与密码强度校验
- 中间件：`helmet`（通用安全头）、`cors`（跨域控制）、`express-rate-limit`（限流：15 分钟/每 IP 100 次）。
- 身份令牌：当前为演示用字符串，建议使用 JWT 库并设置签名密钥与过期时间。
- 密码哈希：`bcryptjs`，salt rounds = 10。
- 密码强度：当前最小长度 ≥ 6（在注册与重置密码路径校验）。建议提升为长度 ≥ 8，包含大小写字母、数字与特殊字符，并加入常用弱密码黑名单。
- 数据一致性：验证码在真实模式下校验通过后立即 `markCodeUsed`，避免重复使用；请求验证码前清理旧码，降低歧义。

## 涉及/修改的文件
- `frontend/src/components/ForgotPasswordForm.tsx`
  - 新增 DEV_CAPTCHA_ANSWER（`91`）与前置校验，仅当图形验证码正确时可点「获取验证码」。
  - 新增前端短信验证码比对逻辑：优先与后端 `debugCode` 比对，缺省比对 `123456`。
  - 完善错误提示文案；更新图片渲染为 `<img src="/captcha.png" />` 并加入加载失败回退。
  - 优化 aria/title 文案：明确题面为「13 + 78 = ?」。
- `frontend/src/components/ForgotPasswordForm.css`
  - 对齐登录页的验证码容器样式，新增 `.captcha-img`，保证图片在容器内自适应展示。
- `frontend/src/components/LoginForm.tsx`
  - 新增 DEV_SMS_CODE（`123456`）与前端短信验证码比对逻辑：与后端 `debugCode` 一致或使用默认值一致，否则阻断登录并提示错误。
- 公共资源：`frontend/public/captcha.png`（图形验证码图片），`frontend/public/qrcode.png`（登录页二维码图片）。

## 预览与验证
- 预览地址（Vite 开发服务）：`http://localhost:5173/`
- 验证项：
  1) 忘记密码页：图形验证码输入框 placeholder 为「请输入图形验证码」，右侧显示题面图片；当输入为 `91` 且手机号合法时，「获取验证码」可点击，否则禁用或提示错误；
  2) 忘记密码页：收码后，若后端返回 `debugCode`，则仅当用户输入与 `debugCode` 相等时可提交重置；若未返回 `debugCode`，用户输入需为 `123456`；
  3) 登录页（短信登录）：请求验证码后，用户输入需与 `debugCode` 或 `123456` 相等，否则前端拦截并提示「验证码错误」。
  4) 图形验证码图片加载失败时，回退显示文字题面「13 + 78 = ?」。
  5) 后端接口验证：`/api/auth/request-code` 在 60 秒内对同手机号+用途限频；登录/注册/重置密码在真实模式下严格校验验证码并标记已使用；`/health` 返回正常。

## 待办/后续优化
- 将注册页的短信验证码校验与图形验证码前置条件统一为上述伪功能逻辑，提升一致性；
- 增加前端「验证码已发送：123456」的提示样式或弹窗，统一各页的反馈体验；
- 提供图形验证码刷新按钮与更灵活的题面配置（从配置文件或环境变量读取）；
- 在纯前端伪功能模式下，可选择跳过后端请求（`/api/auth/request-code`），直接前端触发倒计时并展示 `debugCode`/`123456`；
- 在 CI 中加入前端 UI 测试，覆盖忘记密码与登录页的伪功能交互。

---
本文件用于归档本次会话的提示词与变更要点，便于后续团队协作与需求追踪。